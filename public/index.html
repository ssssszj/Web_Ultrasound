<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <script src='https://docs.opencv.org/3.3.1/opencv.js' type="text/javascript"></script>
</head>

<body style="background-color: #56565b">
    <video id="cameraFeed" autoplay ></video>
    <canvas id="canvasOne" class="myCanvas" width="310" height="250"></canvas>
    <br>
    <p id="result" style="width:100px; height:75px;"></p>
    <canvas id="capturedCanvas" style="display: none;"></canvas>

    <h1 style="color: aliceblue; text-align: center;">宫颈区域面积：<label id="Area"></label></h1>
    <h1 style="color: aliceblue; text-align: center;">宫颈区域周长：<label id="Perimeter"></label></h1>
    <h1 style="color: aliceblue; text-align: center;">黑色区域面积：<label id="BA"></label></h1>
    <h1 style="color: aliceblue; text-align: center;">黑色区域占比：<label id="BP"></label></h1>
    <h1 style="color: aliceblue; text-align: center;">宫颈凹陷程度：<label id="ConC"></label></h1>
    <script>
        function getMat(input,input_data){
            const text_label = document.getElementById('result');
            let canvas = document.getElementById('canvasOne');
            console.log(canvas.width, canvas.height);
            let mask = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
            let ctx = canvas.getContext('2d');
            let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            mask.data.set(imgData.data);
            console.log(mask.rows, mask.cols, mask.channels());

            //Cervix Mask
            let gray = new cv.Mat();
            cv.cvtColor(mask, gray, cv.COLOR_BGR2GRAY);
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(gray, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);
            let areas = [];
            for(let i = 0; i < contours.size(); ++i){
                areas.push(cv.contourArea(contours.get(i)));
            }
            let maxIdx = areas.indexOf(Math.max(...areas));
            console.log("maxIdx:",maxIdx);
            let themask = new cv.Mat.zeros(gray.rows, gray.cols, cv.CV_8UC3);
            let outputcanvas = document.getElementById('outputcanvas');
            if(outputcanvas == null){
                outputcanvas = document.createElement('canvas');
                outputcanvas.id = 'outputcanvas';
                outputcanvas.width = canvas.width;
                outputcanvas.height = canvas.height;
                document.body.insertBefore(outputcanvas,text_label);
            }
            console.log(typeof(outputcanvas));
            cv.drawContours(themask, contours,maxIdx, new cv.Scalar(255, 255, 255),-1);
            cv.imshow('outputcanvas', themask);
            
            //Area and Perimeter
            let cervix_area = document.getElementById('Area');
            cervix_area.innerHTML = cv.contourArea(contours.get(maxIdx)).toFixed(2);
            let cervix_perimeter = document.getElementById('Perimeter');
            cervix_perimeter.innerHTML = cv.arcLength(contours.get(maxIdx), true).toFixed(2);
            let input_array = new Uint8Array(input_data);

            //Black Area
            let origin_img = new cv.Mat(input.shape[0],input.shape[1],cv.CV_8UC3);
            origin_img.data.set(input_array);
            let reverse_mask = new cv.Mat();
            let mat = new cv.Mat(input.shape[0],input.shape[1],cv.CV_8UC3,new cv.Scalar(255,255,255));
            let segment_img = new cv.Mat();
            cv.subtract(mat,themask,reverse_mask);
            cv.add(origin_img,reverse_mask,segment_img);
            let segment_gray = new cv.Mat();
            cv.cvtColor(segment_img, segment_gray, cv.COLOR_BGR2GRAY);
            cv.threshold(segment_gray, segment_gray, 80,255,cv.THRESH_BINARY_INV);

            black_contours = new cv.MatVector();
            black_hierarchy = new cv.Mat();
            cv.findContours(segment_gray,black_contours, black_hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);
            let black_areas = [];
            for(let i = 0; i < black_contours.size(); ++i){
                black_areas.push(cv.contourArea(black_contours.get(i)));
            }
            let black_maxIdx = black_areas.indexOf(Math.max(...black_areas));
            let BA = document.getElementById('BA');
            let BP = document.getElementById('BP');
            let black_area = new cv.Mat.zeros(gray.rows, gray.cols, cv.CV_8UC3);
            console.log("black_maxIdx:",black_maxIdx);
            if(black_maxIdx >= 0){
                cv.drawContours(black_area, black_contours,black_maxIdx, new cv.Scalar(255, 255, 255),-1);
                BA.innerHTML = cv.contourArea(black_contours.get(black_maxIdx)).toFixed(2);
                BP.innerHTML = (cv.contourArea(black_contours.get(black_maxIdx))/cv.contourArea(contours.get(maxIdx))*100).toFixed(2) + '%';
            }else{
                BA.innerHTML = 0;
                BP.innerHTML = 0;
            }
            cv.subtract(mat,black_area,black_area);
            cv.add(origin_img,black_area,black_area)
            cv.imshow('outputcanvas', black_area);
        
            //Concavity
            let convexHull = new cv.Mat();
            cv.convexHull(contours.get(maxIdx), convexHull, false, true);
            let hull_area = cv.contourArea(convexHull);
            let ConC = document.getElementById('ConC');
            ConC.innerHTML = ((hull_area - cv.contourArea(contours.get(maxIdx)))/hull_area*100).toFixed(2) + '%';
            mask.delete();
            gray.delete();
            contours.delete();
            hierarchy.delete();
            themask.delete();
            origin_img.delete();
            reverse_mask.delete();
            mat.delete();
            segment_img.delete();
            segment_gray.delete();
            black_contours.delete();
            black_hierarchy.delete();
            black_area.delete();
            convexHull.delete();
        }
        window.getMat = getMat;
    </script>
    <script type="text/babel" src="index.js"></script>

</body>

</html>